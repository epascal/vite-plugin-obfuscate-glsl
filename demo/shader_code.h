uniform mat4 worldView,world,view;uniform vec3 cameraPosition;uniform samplerCube envMaps[6];uniform sampler2D surfaceMaps[8],normalMap,physicalMap;uniform mat4 invView;uniform int useNormal;uniform vec4 diffusColor,ambientColor;uniform float amplification,flatShininess,scratchVisibility;uniform mat4 localAnomalies[100],surfaceTreatments[100];uniform int anomalyInstances,treatmentInstances;varying vec3 reflectedVector;varying vec4 vPosition;varying vec3 vNormal;flat in float fHashColor;varying vec2 vUv;varying vec3 posEye;varying mat3 vTBN;
#define M_PI 3.1415926535897932384626433832795
#define SCRATCH 1
#define MARK 2
#define DEFORMATION 3
#define STAIN 4
#define TREATMENT 5
vec3 f(mat3 i,vec3 v,float e){v=v*2.-1.;v.x=v.x*e;v.y=v.y*e;return i*v;}vec3 f(vec3 v,float e){if(e==1.)return v;vec3 i=(v-.5)*2.;i.x=asin(i.x);i.y=asin(i.y);i.z=acos(i.z);i*=e;i.x=sin(i.x);i.y=sin(i.y);i.z=cos(i.z);i/=length(i);return i/2.+.5;}vec3 e(vec3 v,float i,float y){if(i==1.||v.z==1.)return v;vec3 f=(v-.5)*2.;f=vec3(f.x*i-f.y*-y,f.x*-y+f.y*i,f.z);return f/2.+.5;}vec4 e(float i){vec4 v=vec4(1,2,3,4)-i,f=v*v*v;float e=f.x,l=f.y-4.*f.x,y=f.z-4.*f.y+6.*f.x;return vec4(e,l,y,6.-e-l-y)*(1./6.);}vec4 e(sampler2D i,vec2 v){vec2 f=vec2(textureSize(i,0));v=v*f-.5;vec2 t=fract(v);v-=t;vec4 s=e(t.x),l=e(t.y),y=v.xxyy+vec2(-.5,1.5).xyxy,r=vec4(s.xz+s.yw,l.xz+l.yw),u=y+vec4(s.yw,l.yw)/r;u*=(1./f).xxyy;vec4 p=texture(i,u.xz),z=texture(i,u.yz),x=texture(i,u.xw),n=texture(i,u.yw);float w=r.x/(r.x+r.y);return mix(mix(n,x,w),mix(z,p,w),r.z/(r.z+r.w));}vec4 i(highp int i,vec2 f){vec4 v;if(i<0)return vec4(.5,.5,1,0);if(i==0)v=e(surfaceMaps[0],f);else if(i==1)v=e(surfaceMaps[1],f);else if(i==2)v=e(surfaceMaps[2],f);else if(i==3)v=e(surfaceMaps[3],f);else if(i==4)v=e(surfaceMaps[4],f);else if(i==5)v=e(surfaceMaps[5],f);return v;}vec4 e(vec3 i,vec3 v,float y,float s,float w,float l,float m){vec3 p=f(vTBN,e(f(i.xyz,w),l,m),y),r;r=vec3(invView*vec4(reflect(v,normalize(vec3(view*vec4(p,0)))),0));vec4 z=vec4(0),x=vec4(0);s=1.-s;highp int n=int(floor(s*5.));float u=0.;if(n==0)z=textureCube(envMaps[0],r),x=textureCube(envMaps[1],r),u=s*5.;else if(n==1)z=textureCube(envMaps[1],r),x=textureCube(envMaps[2],r),u=(s-.2)*5.;else if(n==2)z=textureCube(envMaps[2],r),x=textureCube(envMaps[3],r),u=(s-.4)*5.;else if(n==3)z=textureCube(envMaps[3],r),x=textureCube(envMaps[4],r),u=(s-.6)*5.;else if(n==4)z=textureCube(envMaps[4],r),x=textureCube(envMaps[5],r),u=(s-.8)*5.;else if(n==5)z=textureCube(envMaps[4],r),x=textureCube(envMaps[5],r),u=1.;vec4 k=mix(z,x,u);return k;}vec2 e(vec2 i,float v,float s,float p,float y,float f,float w,float r,float e){i=vec2((i.x-f)*r,(i.y-w)*r);i=vec2(v*i.x-s*i.y+p,(s*i.x+v*i.y)*e+y);return i;}void main(){vec3 v=normalize(posEye);bool f=false;highp int s=0;float r=1.;vec2 u=vUv,l=vUv;float x=1.;bool n=false,y=false;float z=1.,w=0.;vec4 t=diffusColor;highp int p=0;if(useNormal==0){gl_FragColor=vec4(1);return;}if(useNormal==1){for(int m=0;m<anomalyInstances;m++){if(fHashColor!=localAnomalies[m][3][0])continue;float a=max(localAnomalies[m][1][0],localAnomalies[m][1][1]);if(abs(vUv.x-localAnomalies[m][1][2])<a/localAnomalies[m][2][0]&&abs(vUv.y-localAnomalies[m][1][3])<a/localAnomalies[m][2][0]){s=int(round(localAnomalies[m][2][3]));r=localAnomalies[m][3][3];l=e(vUv,localAnomalies[m][0][2],localAnomalies[m][0][3],localAnomalies[m][0][0],localAnomalies[m][0][1],localAnomalies[m][1][2],localAnomalies[m][1][3],localAnomalies[m][2][0],localAnomalies[m][2][1]);if(l.x>=localAnomalies[m][0][0]-localAnomalies[m][1][0]+.003&&l.y>=localAnomalies[m][0][1]-localAnomalies[m][1][1]+.003&&l.x<=localAnomalies[m][0][0]+localAnomalies[m][1][0]-.003&&l.y<=localAnomalies[m][0][1]+localAnomalies[m][1][1]-.003){f=true;z=localAnomalies[m][0][2];w=localAnomalies[m][0][3];x=localAnomalies[m][2][2];if(s==STAIN&&texture2D(physicalMap,l).y<1.){n=true;break;}else if(s!=STAIN&&texture2D(normalMap,l).z!=1.){y=true;n=false;break;}}}}if(y)for(int m=0;m<treatmentInstances;m++){if(fHashColor!=surfaceTreatments[m][1][1])continue;t=vec4(surfaceTreatments[m][0][0],surfaceTreatments[m][1][0],surfaceTreatments[m][2][0],1);}else{bool m=false;for(int b=0;b<treatmentInstances;b++){if(fHashColor!=surfaceTreatments[b][1][1])continue;s=TREATMENT;x=surfaceTreatments[b][2][2];r=surfaceTreatments[b][3][3];float a=surfaceTreatments[b][3][2];p=int(round(surfaceTreatments[b][2][1]));u=vec2(mod(vUv.x*a+surfaceTreatments[b][0][2],1.),mod(vUv.y*a+surfaceTreatments[b][0][3],1.));t=vec4(surfaceTreatments[b][0][0],surfaceTreatments[b][1][0],surfaceTreatments[b][2][0],1);f=true;m=true;break;}if(!m&&!y&&!n)f=false;}}vec4 m;if(useNormal==1&&f){vec4 a=s==TREATMENT?i(p,u):texture2D(normalMap,l),b=s==TREATMENT?vec4(1,1,.2,0):texture2D(physicalMap,l);if(n&&s==TREATMENT){vec4 T=texture2D(physicalMap,l);x*=T.y;}if(!n&&s==TREATMENT)z=1.,w=0.;if((s==MARK||s==SCRATCH)&&a.z<1.||s==TREATMENT){vec4 T;if(s==MARK||s==TREATMENT)m=e(a.xyz,v,1.,x*flatShininess*b.y,r,z,w);else if(b.x<1.)T=e(a.xyz,v,1.,0.,r,z,w)*scratchVisibility,m=T,m=m*.5+m*b.x;else{T=e(a.xyz,v,1.,x*flatShininess*b.y,r,z,w)*scratchVisibility;m=T;vec4 k=e(vec3(.5,.5,1),v,1.,x*flatShininess*b.y,1.,z,w);m=mix(k,m,1.-a.w);}}else{vec4 T=e(vec3(.5,.5,1),v,1.,x*flatShininess*b.y,1.,z,w);m=T;}vec4 T=t;if(n){vec4 k=texture2D(normalMap,l),A=texture2D(physicalMap,l);T=mix(vec4(k.xyz,1),T,A.y);}gl_FragColor=mix(m*T*amplification+ambientColor,T,b.w);}else{vec4 T=e(vec3(.5,.5,1),v,1.,flatShininess,1.,z,w);gl_FragColor=T*diffusColor*amplification+ambientColor;}}